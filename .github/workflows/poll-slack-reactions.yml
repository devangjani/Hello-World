name: Poll Slack for Eye Emoji Reactions

on:
  schedule:
    # Run every 1 minute
    - cron: '*/1 * * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-reactions:
    runs-on: ubuntu-latest
    steps:
      - name: Check for eye emoji reactions
        uses: actions/github-script@v7
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        with:
          script: |
            const slackToken = process.env.SLACK_BOT_TOKEN;
            const channelId = process.env.SLACK_CHANNEL_ID;
            
            if (!slackToken || !channelId) {
              console.log('‚ö†Ô∏è SLACK_BOT_TOKEN or SLACK_CHANNEL_ID not configured');
              return;
            }
            
            // Get recent messages from Slack channel (last 2 minutes only for fresh reactions)
            const twoMinutesAgo = (Date.now() / 1000) - 120; // 2 minutes in seconds
            const messagesResponse = await fetch(
              `https://slack.com/api/conversations.history?channel=${channelId}&limit=20&oldest=${twoMinutesAgo}`,
              { headers: { 'Authorization': `Bearer ${slackToken}` }}
            );
            const messagesData = await messagesResponse.json();
            
            if (!messagesData.ok) {
              console.log('‚ùå Failed to fetch Slack messages:', messagesData.error);
              return;
            }
            
            console.log(`üì• Found ${messagesData.messages.length} recent messages`);
            
            // Process each message
            for (const message of messagesData.messages) {
              // Check if message has eye emoji reactions
              const eyesReaction = message.reactions?.find(r => r.name === 'eyes');
              if (!eyesReaction) continue;
              
              // Extract ALL PR numbers from message (handles multiple PRs in one message)
              // Try multiple formats: plain text (#123) and Slack links (/pull/123|)
              const messageText = message.text || '';
              
              // First try to get from blocks (more reliable for formatted messages)
              let prNumbers = [];
              if (message.blocks) {
                const blocksText = JSON.stringify(message.blocks);
                const blockMatches = blocksText.matchAll(/\/pull\/(\d+)\|/g);
                prNumbers = Array.from(blockMatches).map(match => parseInt(match[1]));
              }
              
              // Fallback to plain text format if no PRs found in blocks
              if (prNumbers.length === 0) {
                const plainMatches = messageText.matchAll(/#(\d+):/g);
                prNumbers = Array.from(plainMatches).map(match => parseInt(match[1]));
              }
              
              if (prNumbers.length === 0) {
                console.log('‚ö†Ô∏è No PR numbers found in message with üëÄ reaction');
                continue;
              }
              
              console.log(`Found üëÄ reaction on message with PRs: ${prNumbers.join(', ')}`);
              
              // Get users who reacted
              for (const userId of eyesReaction.users) {
                // Get user info from Slack
                const userResponse = await fetch(
                  `https://slack.com/api/users.info?user=${userId}`,
                  { headers: { 'Authorization': `Bearer ${slackToken}` }}
                );
                const userData = await userResponse.json();
                const slackEmail = userData.user?.profile?.email;
                const slackName = userData.user?.real_name || userData.user?.name;
                
                console.log(`üë§ Processing reaction from: ${slackName} (${slackEmail || 'no email'})`);
                
                // Try to find GitHub user by email
                let githubUsername = null;
                if (slackEmail) {
                  try {
                    const { data: searchResults } = await github.rest.search.users({
                      q: `${slackEmail} in:email`
                    });
                    if (searchResults.items.length > 0) {
                      githubUsername = searchResults.items[0].login;
                      console.log(`‚úÖ Found GitHub user: @${githubUsername}`);
                    } else {
                      console.log(`‚ö†Ô∏è No GitHub user found with email: ${slackEmail}`);
                    }
                  } catch (error) {
                    console.log(`‚ö†Ô∏è Could not search for GitHub user: ${error.message}`);
                  }
                } else {
                  console.log('‚ö†Ô∏è No email found in Slack profile');
                }
                
                // Process each PR in the message
                for (const prNumber of prNumbers) {
                  console.log(`\nüîÑ Processing PR #${prNumber}...`);
                  
                  // Check existing reviewers first
                  let existingReviewers = [];
                  let prAuthor = null;
                  try {
                    const { data: pr } = await github.rest.pulls.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: prNumber
                    });
                    existingReviewers = pr.requested_reviewers?.map(r => r.login) || [];
                    prAuthor = pr.user.login;
                    console.log(`PR Author: ${prAuthor}`);
                    console.log(`Current reviewers: ${existingReviewers.length > 0 ? existingReviewers.join(', ') : 'None'}`);
                  } catch (error) {
                    console.log(`‚ö†Ô∏è Could not fetch PR details: ${error.message}`);
                  }
                  
                  // Check if trying to assign PR author as reviewer
                  if (githubUsername && prAuthor && githubUsername === prAuthor) {
                    console.log(`‚ö†Ô∏è Cannot assign @${githubUsername} as reviewer - they are the PR author`);
                    // Still add comment but skip reviewer assignment
                    const commentBody = `üëÄ **Being reviewed by ${slackName}**\n\n_Note: Cannot assign PR author as reviewer, but tracking this claim._`;
                    try {
                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber,
                        body: commentBody
                      });
                      console.log(`‚úÖ Added comment to PR #${prNumber}`);
                    } catch (error) {
                      console.log(`‚ö†Ô∏è Could not add comment: ${error.message}`);
                    }
                    continue;
                  }
                  
                  // Skip if this user is already a reviewer
                  if (githubUsername && existingReviewers.includes(githubUsername)) {
                    console.log(`‚è≠Ô∏è @${githubUsername} is already a reviewer on PR #${prNumber}`);
                    continue;
                  }
                  
                  // Add comment to PR
                  const reviewerName = githubUsername ? `@${githubUsername}` : slackName;
                  const commentBody = `üëÄ **Getting reviewed by ${reviewerName}**\n\n_Claimed via Slack emoji reaction._`;
                  
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      body: commentBody
                    });
                    console.log(`‚úÖ Added comment to PR #${prNumber} for ${reviewerName}`);
                  } catch (error) {
                    console.log(`‚ö†Ô∏è Could not add comment: ${error.message}`);
                    continue;
                  }
                  
                  // Add reviewer if we found GitHub username
                  if (githubUsername) {
                    try {
                      console.log(`üîÑ Attempting to add @${githubUsername} as reviewer...`);
                      const result = await github.rest.pulls.requestReviewers({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber,
                        reviewers: [githubUsername]
                      });
                      console.log(`‚úÖ Successfully added @${githubUsername} as reviewer to PR #${prNumber}`);
                      console.log(`Reviewer assignment result:`, JSON.stringify(result.data.requested_reviewers.map(r => r.login)));
                    } catch (error) {
                      console.log(`‚ùå Failed to add reviewer: ${error.message}`);
                      console.log(`Error status: ${error.status}`);
                      console.log(`Error details:`, JSON.stringify(error.response?.data || {}));
                    }
                  } else {
                    console.log(`‚ö†Ô∏è Cannot assign reviewer - GitHub username not found for ${slackName}`);
                  }
                }
                
                // Optional: Remove the reaction to mark as processed
                try {
                  await fetch(
                    'https://slack.com/api/reactions.remove',
                    {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${slackToken}`,
                        'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                        channel: channelId,
                        timestamp: message.ts,
                        name: 'eyes'
                      })
                    }
                  );
                  console.log('‚úÖ Removed üëÄ reaction (marked as processed)');
                } catch (error) {
                  console.log('‚ö†Ô∏è Could not remove reaction');
                }
              }
            }
